{% extends 'base.html' %}
{% load static %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<style>
    .nav-tabs .nav-link {
        color: #495057;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        margin-right: 5px;
    }
    .nav-tabs .nav-link.active {
        color: #007bff;
        background-color: #fff;
        border-bottom-color: transparent;
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .status-badge i {
        font-size: 0.9em;
    }
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    .status-approved {
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    .status-rejected {
        background-color: #f8d7da;
        color: #842029;
        border: 1px solid #f5c2c7;
    }
    .status-pending_deputy {
        background-color: #cfe2ff;
        color: #084298;
        border: 1px solid #b6d4fe;
    }
    .status-pending_executive {
        background-color: #e2e3e5;
        color: #41464b;
        border: 1px solid #d3d6d8;
    }
    .status-pending_ceo {
        background-color: #d3d3d3;
        color: #1a1e21;
        border: 1px solid #c6c8ca;
    }
    .action-buttons .btn {
        padding: 2px 8px;
        font-size: 0.85em;
    }
    .tab-pane {
        padding: 20px;
        border: 1px solid #dee2e6;
        border-top: none;
    }
    .amount-cell {
        font-family: monospace;
        text-align: right;
    }
    .date-cell {
        white-space: nowrap;
    }
    .balance-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .balance-card:hover {
        transform: translateY(-2px);
    }
    .balance-card.total { border-color: #0d6efd; }
    .balance-card.income { border-color: #198754; }
    .balance-card.expense { border-color: #dc3545; }
    .balance-card.advance { border-color: #ffc107; }
    .balance-card.payable { border-color: #17a2b8; }
    .balance-amount {
        font-size: 1.5rem;
        font-weight: bold;
        font-family: monospace;
    }
    .installment-list {
        max-height: 200px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Balance Summary Section -->
<div class="container-fluid mt-4">
    <div class="row g-3 mb-4">
        <!-- Total Balance -->
        <div class="col">
            <div class="card shadow-sm balance-card total h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-1">Total Balance</h6>
                    <div class="balance-amount text-primary">
                        {{ total_balance|floatformat:2 }} AFN
                    </div>
                    <small class="text-muted">Updated: {{ last_update|date:"Y-m-d H:i" }}</small>
                </div>
            </div>
        </div>
        <!-- Income Total -->
        <div class="col">
            <div class="card shadow-sm balance-card income h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-1">Total Income</h6>
                    <div class="balance-amount text-success">
                        {{ total_income|floatformat:2 }} AFN
                    </div>
                    <small class="text-muted">From {{ income_records.count }} records</small>
                </div>
            </div>
        </div>
        <!-- Expense Total -->
        <div class="col">
            <div class="card shadow-sm balance-card expense h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-1">Total Expenses</h6>
                    <div class="balance-amount text-danger">
                        {{ total_expenses|floatformat:2 }} AFN
                    </div>
                    <small class="text-muted">From {{ expense_records.count }} records</small>
                </div>
            </div>
        </div>
        <!-- Outstanding Advances -->
        <div class="col">
            <div class="card shadow-sm balance-card advance h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-1">Outstanding Advances</h6>
                    <div class="balance-amount text-warning">
                        {{ outstanding_advances|floatformat:2 }} AFN
                    </div>
                    <small class="text-muted">From {{ pending_advances }} advances</small>
                </div>
            </div>
        </div>
        <!-- Outstanding Payables -->
        <div class="col">
            <div class="card shadow-sm balance-card payable h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-1">Payables</h6>
                    <div class="balance-amount text-info">
                        {{ total_payables|floatformat:2 }} AFN
                    </div>
                    <small class="text-muted">From {{ pending_payables }} unpaid payables</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="recordTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="all-tab" data-bs-toggle="tab" href="#all" role="tab">
                <i class="fas fa-table me-2"></i>All Records
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="income-tab" data-bs-toggle="tab" href="#income" role="tab">
                <i class="fas fa-arrow-up me-2"></i>Income
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="expense-tab" data-bs-toggle="tab" href="#expense" role="tab">
                <i class="fas fa-arrow-down me-2"></i>Expense
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="advance-tab" data-bs-toggle="tab" href="#advance" role="tab">
                <i class="fas fa-forward me-2"></i>Advance
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="balance-tab" data-bs-toggle="tab" href="#balance" role="tab">
                <i class="fas fa-balance-scale me-2"></i>Balance
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="payable-tab" data-bs-toggle="tab" href="#payable" role="tab">
                <i class="fas fa-hand-holding-usd me-2"></i>Payables
            </a>
        </li>
        {% if user.is_superuser %}
        <li class="nav-item ms-auto">
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAllRecordsModal">
                <i class="fas fa-trash-alt me-2"></i>Delete All Records
            </button>
        </li>
        {% endif %}
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="recordTabsContent">
        <!-- All Records Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Records</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToCSV('allRecordsTable', 'all_records')">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToExcel('allRecordsTable', 'all_records')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="allRecordsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in all_records %}
                                <tr>
                                    <td class="date-cell">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.reference_number }}</td>
                                    <td>{{ record.transaction_type|title }}</td>
                                    <td>{{ record.description }}</td>
                                    <td class="amount-cell">{{ record.amount|floatformat:2 }} AFN</td>
                                    <td>
                                        <span class="status-badge status-{{ record.status }}">
                                            {% if record.status == 'pending' %}
                                                <i class="fas fa-clock"></i>
                                            {% elif record.status == 'approved' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif record.status == 'rejected' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif record.status == 'pending_deputy' %}
                                                <i class="fas fa-user-clock"></i>
                                            {% elif record.status == 'pending_executive' %}
                                                <i class="fas fa-user-shield"></i>
                                            {% elif record.status == 'pending_ceo' %}
                                                <i class="fas fa-crown"></i>
                                            {% endif %}
                                            {{ record.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ record.created_by.username }}</td>
                                    <td class="action-buttons">
                                        <a href="{% url 'website:record_detail' record.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if user.is_superuser or user == record.created_by %}
                                        <a href="{% url 'website:edit_record' record.id %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Income Tab -->
        <div class="tab-pane fade" id="income" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Income Records</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToCSV('incomeTable', 'income_records')">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToExcel('incomeTable', 'income_records')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="incomeTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Source</th>
                                    <th>Category</th>
                                    <th>Payment Method</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in income_records %}
                                <tr>
                                    <td class="date-cell">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.reference_number }}</td>
                                    <td>{{ record.get_income_source_display|default:"-" }}</td>
                                    <td>{{ record.get_income_category_display|default:"-" }}</td>
                                    <td>{{ record.get_payment_method_display|default:"-" }}</td>
                                    <td>{{ record.description }}</td>
                                    <td class="amount-cell">{{ record.amount|floatformat:2 }} AFN</td>
                                    <td>
                                        <span class="status-badge status-{{ record.status }}">
                                            {% if record.status == 'pending' %}
                                                <i class="fas fa-clock"></i>
                                            {% elif record.status == 'approved' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif record.status == 'rejected' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif record.status == 'pending_deputy' %}
                                                <i class="fas fa-user-clock"></i>
                                            {% elif record.status == 'pending_executive' %}
                                                <i class="fas fa-user-shield"></i>
                                            {% elif record.status == 'pending_ceo' %}
                                                <i class="fas fa-crown"></i>
                                            {% endif %}
                                            {{ record.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ record.created_by.username }}</td>
                                    <td class="action-buttons">
                                        <a href="{% url 'website:record_detail' record.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if user.is_superuser or user == record.created_by %}
                                        <a href="{% url 'website:edit_record' record.id %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expense Tab -->
        <div class="tab-pane fade" id="expense" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Expense Records</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToCSV('expenseTable', 'expense_records')">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToExcel('expenseTable', 'expense_records')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="expenseTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Vendor</th>
                                    <th>Receipt #</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in expense_records %}
                                <tr>
                                    <td class="date-cell">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.reference_number }}</td>
                                    <td>{{ record.get_expense_category_display|default:"-" }}</td>
                                    <td>{{ record.get_expense_type_display|default:"-" }}</td>
                                    <td>{{ record.vendor|default:"-" }}</td>
                                    <td>{{ record.receipt_number|default:"-" }}</td>
                                    <td>{{ record.description }}</td>
                                    <td class="amount-cell">{{ record.amount|floatformat:2 }} AFN</td>
                                    <td>
                                        <span class="status-badge status-{{ record.status }}">
                                            {% if record.status == 'pending' %}
                                                <i class="fas fa-clock"></i>
                                            {% elif record.status == 'approved' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif record.status == 'rejected' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif record.status == 'pending_deputy' %}
                                                <i class="fas fa-user-clock"></i>
                                            {% elif record.status == 'pending_executive' %}
                                                <i class="fas fa-user-shield"></i>
                                            {% elif record.status == 'pending_ceo' %}
                                                <i class="fas fa-crown"></i>
                                            {% endif %}
                                            {{ record.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ record.created_by.username }}</td>
                                    <td class="action-buttons">
                                        <a href="{% url 'website:record_detail' record.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if user.is_superuser or user == record.created_by %}
                                        <a href="{% url 'website:edit_record' record.id %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advance Tab -->
        <div class="tab-pane fade" id="advance" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Advance Records</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToCSV('advanceTable', 'advance_records')">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToExcel('advanceTable', 'advance_records')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="advanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Description</th>
                                    <th>Recipient</th>
                                    <th>Position</th>
                                    <th>Payment Method</th>
                                    <th>Amount</th>
                                    <th>Remaining</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in advance_records %}
                                {% with remaining=record.get_remaining_amount %}
                                <tr>
                                    <td class="date-cell">{{ record.created_at|date:"Y-m-d" }}</td>
                                    <td>{{ record.reference_number }}</td>
                                    <td>{{ record.description }}</td>
                                    <td>{{ record.recipient_name|default:"-" }}</td>
                                    <td>{{ record.recipient_position|default:"-" }}</td>
                                    <td>{{ record.get_payment_method_display|default:"-" }}</td>
                                    <td class="amount-cell">{{ record.amount|floatformat:2 }} AFN</td>
                                    <td class="amount-cell">{{ remaining|floatformat:2 }} AFN</td>
                                    <td>
                                        {% if remaining == 0 %}
                                            <span class="badge bg-success">Paid</span>
                                        {% elif remaining < record.amount %}
                                            <span class="badge bg-warning">Partial</span>
                                        {% else %}
                                            <span class="badge bg-danger">Unpaid</span>
                                        {% endif %}
                                    </td>
                                    <td class="action-buttons">
                                        {% if record.status == 'approved' and remaining > 0 %}
                                            <a href="{% url 'website:advance_repayment' record.id %}" class="btn btn-sm btn-success" title="Repay Advance">
                                                <i class="fas fa-money-bill-wave"></i> Repay
                                            </a>
                                        {% endif %}
                                        <a href="{% url 'website:record_detail' record.id %}" class="btn btn-sm btn-info" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if user.is_superuser or user == record.created_by %}
                                            <a href="{% url 'website:edit_record' record.id %}" class="btn btn-sm btn-warning" title="Edit Record">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endwith %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Tab -->
        <div class="tab-pane fade" id="balance" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Balance Records</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToCSV('balanceTable', 'balance_records')">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToExcel('balanceTable', 'balance_records')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="balanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Type</th>
                                    <th>Account</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in balance_records %}
                                <tr>
                                    <td class="date-cell">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.reference_number }}</td>
                                    <td>{{ record.get_balance_type_display|default:"-" }}</td>
                                    <td>{{ record.account|default:"-" }}</td>
                                    <td>{{ record.description }}</td>
                                    <td class="amount-cell">{{ record.amount|floatformat:2 }} AFN</td>
                                    <td>
                                        <span class="status-badge status-{{ record.status }}">
                                            {% if record.status == 'pending' %}
                                                <i class="fas fa-clock"></i>
                                            {% elif record.status == 'approved' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif record.status == 'rejected' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif record.status == 'pending_deputy' %}
                                                <i class="fas fa-user-clock"></i>
                                            {% elif record.status == 'pending_executive' %}
                                                <i class="fas fa-user-shield"></i>
                                            {% elif record.status == 'pending_ceo' %}
                                                <i class="fas fa-crown"></i>
                                            {% endif %}
                                            {{ record.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ record.created_by.username }}</td>
                                    <td class="action-buttons">
                                        <a href="{% url 'website:record_detail' record.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if user.is_superuser or user == record.created_by %}
                                        <a href="{% url 'website:edit_record' record.id %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payables Tab -->
        <div class="tab-pane fade" id="payable" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Payable Records</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToCSV('payableTable', 'payable_records')">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTableToExcel('payableTable', 'payable_records')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="payableTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reference</th>
                                    <th>Payment Type</th>
                                    <th>Lender</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in payable_records %}
                                <tr>
                                    <td class="date-cell">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.reference_number }}</td>
                                    <td>{{ record.payment_method|title }}</td>
                                    <td>{{ record.lender_name }}</td>
                                    <td>{{ record.due_date|date:"Y-m-d" }}</td>
                                    <td class="amount-cell">{{ record.amount|floatformat:2 }} AFN</td>
                                    <td>
                                        <span class="status-badge {% if record.is_paid %}status-approved{% else %}status-pending{% endif %}">
                                            {% if record.is_paid %}Paid{% else %}Unpaid{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ record.created_by.username }}</td>
                                    <td class="action-buttons">
                                        <a href="{% url 'website:record_detail' record.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if not record.is_paid and user.user_type in 'data_entry,cashier' %}
                                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#payableRepaymentModal_{{ record.id }}">
                                            <i class="fas fa-money-bill"></i>
                                        </button>
                                        {% endif %}
                                        {% if user.is_superuser or user == record.created_by %}
                                        <a href="{% url 'website:edit_record' record.id %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payback Modal -->
<div class="modal fade" id="paybackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Advance Payback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="paybackForm" method="POST" action="{% url 'website:record_payback' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="record_id" id="paybackRecordId">
                    <div class="mb-3">
                        <label class="form-label">Amount to Pay Back</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="amount" 
                                   step="0.01" required id="paybackAmount">
                            <span class="input-group-text">AFN</span>
                        </div>
                        <small class="text-muted">Remaining: <span id="remainingAmount">0.00</span> AFN</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" name="payment_method" required>
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="deduction">Salary Deduction</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Installments Modal -->
<div class="modal fade" id="installmentsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="installment-list">
                    <!-- Installments will be loaded here via AJAX -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payable Repayment Modal -->
{% for record in payable_records %}
{% if not record.is_paid %}
<div class="modal fade" id="payableRepaymentModal_{{ record.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'website:payable_repayment' record.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Record Payable Repayment - {{ record.reference_number }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="amount_{{ record.id }}" class="form-label">Payment Amount</label>
                        <div class="input-group">
                            <input type="number" step="0.01" min="0" max="{{ record.amount }}" class="form-control" 
                                id="amount_{{ record.id }}" name="amount" required
                                placeholder="Enter amount">
                            <span class="input-group-text">AFN</span>
                        </div>
                        <small class="text-muted">Total amount to pay: {{ record.amount|floatformat:2 }} AFN</small>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method_{{ record.id }}" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method_{{ record.id }}" name="payment_method" required>
                            <option value="">Select Payment Method</option>
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="check">Check</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="payment_date_{{ record.id }}" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="payment_date_{{ record.id }}" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes_{{ record.id }}" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes_{{ record.id }}" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Delete All Records Confirmation Modal -->
{% if user.is_superuser %}
<div class="modal fade" id="deleteAllRecordsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'website:delete_all_records' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title text-danger">⚠️ Delete All Records</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">Warning: This action cannot be undone!</h6>
                        <p class="mb-0">This will permanently delete all records and reset the database sequence. Are you absolutely sure you want to proceed?</p>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            I understand that this action is irreversible and will delete all records
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete All Records</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize DataTables
    $('#allRecordsTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 10,
        language: {
            search: "Search records:"
        }
    });

    $('#incomeTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 10
    });

    $('#expenseTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 10
    });

    $('#advanceTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 10
    });

    $('#balanceTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 10
    });

    // Handle Payback Modal
    $('#paybackModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const recordId = button.data('record-id');
        const remaining = button.data('remaining');
        
        $('#paybackRecordId').val(recordId);
        $('#remainingAmount').text(remaining.toFixed(2));
        $('#paybackAmount').attr('max', remaining);
    });

    // Handle Installments Modal
    $('#installmentsModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const recordId = button.data('record-id');
        
        // Load installments via AJAX
        $.get(`/website/record/${recordId}/installments/`, function(data) {
            const list = $('.installment-list');
            list.empty();
            
            if (data.installments.length === 0) {
                list.append('<p class="text-muted text-center">No payments recorded yet.</p>');
                return;
            }

            const table = $('<table class="table table-sm">').appendTo(list);
            table.append(`
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Method</th>
                    </tr>
                </thead>
            `);
            
            const tbody = $('<tbody>').appendTo(table);
            data.installments.forEach(item => {
                tbody.append(`
                    <tr>
                        <td>${item.date}</td>
                        <td class="text-end">${item.amount.toFixed(2)} AFN</td>
                        <td>${item.method}</td>
                    </tr>
                `);
            });
        });
    });
});

function exportTableToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tr');
    const csv = [];
    
    for (const row of rows) {
        const rowData = [];
        const cols = row.querySelectorAll('td, th');
        
        for (const col of cols) {
            // Get text content and clean it
            let text = col.textContent.trim();
            
            // Handle special cases
            if (text.includes('AFN')) {
                text = text.replace('AFN', '').trim();
            }
            
            // Handle status badges
            if (col.querySelector('.badge')) {
                text = col.querySelector('.badge').textContent.trim();
            }
            
            // Handle dates
            if (col.classList.contains('date-cell')) {
                const date = new Date(text);
                if (!isNaN(date)) {
                    text = date.toISOString().split('T')[0];
                }
            }
            
            // Handle amounts
            if (col.classList.contains('amount-cell')) {
                text = text.replace(/[^\d.-]/g, '');
            }
            
            // Escape quotes and wrap in quotes if contains comma
            if (text.includes(',')) {
                text = `"${text.replace(/"/g, '""')}"`;
            }
            
            rowData.push(text);
        }
        csv.push(rowData.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}_${formatDate(new Date())}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportTableToExcel(tableId, filename) {
    const table = document.getElementById(tableId);
    
    // Create a copy of the table to modify for export
    const exportTable = table.cloneNode(true);
    
    // Clean up data in the copy
    exportTable.querySelectorAll('td').forEach(cell => {
        // Handle status badges
        const badge = cell.querySelector('.badge');
        if (badge) {
            cell.textContent = badge.textContent.trim();
        }
        
        // Handle amounts
        if (cell.classList.contains('amount-cell')) {
            cell.textContent = cell.textContent.replace(/[^\d.-]/g, '');
        }
        
        // Handle dates
        if (cell.classList.contains('date-cell')) {
            const date = new Date(cell.textContent);
            if (!isNaN(date)) {
                cell.textContent = date.toISOString().split('T')[0];
            }
        }
    });
    
    const ws = XLSX.utils.table_to_sheet(exportTable);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Records');
    
    // Auto-size columns
    const range = XLSX.utils.decode_range(ws['!ref']);
    const cols = [];
    for (let C = range.s.c; C <= range.e.c; ++C) {
        let max_width = 0;
        for (let R = range.s.r; R <= range.e.r; ++R) {
            const cell = ws[XLSX.utils.encode_cell({r: R, c: C})];
            if (cell && cell.v) {
                const text = cell.v.toString();
                max_width = Math.max(max_width, text.length);
            }
        }
        cols[C] = {wch: max_width + 2};
    }
    ws['!cols'] = cols;
    
    XLSX.writeFile(wb, `${filename}_${formatDate(new Date())}.xlsx`);
}

function formatDate(date) {
    return date.toISOString().split('T')[0].replace(/-/g, '');
}
</script>

<!-- Add SheetJS library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
{% endblock %}
{% endblock %}